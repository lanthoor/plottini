name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read  # Minimal default permissions

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
    
    - name: Install uv
      uses: astral-sh/setup-uv@f94ec6bedd8674c4426838e6b50417d36b6ab231  # v5.3.1
      with:
        enable-cache: true
    
    - name: Install dependencies
      run: uv sync --extra dev --python ${{ matrix.python-version }}
    
    - name: Run linting with ruff
      run: uv run ruff check src/ tests/
    
    - name: Run type checking with mypy
      run: uv run mypy src/plottini
    
    - name: Run tests with pytest
      run: uv run pytest --cov=plottini --cov-report=xml --cov-report=term

  build:
    name: Build package
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
    
    - name: Install uv
      uses: astral-sh/setup-uv@f94ec6bedd8674c4426838e6b50417d36b6ab231  # v5.3.1
      with:
        enable-cache: true
    
    - name: Install dependencies
      run: uv sync --extra dev --python 3.10
    
    - name: Build package
      run: uv build
    
    - name: Check package metadata
      run: uv run twine check dist/*

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/plottini
    permissions:
      id-token: write  # Scoped to this job only for trusted publishing

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

    - name: Install uv
      uses: astral-sh/setup-uv@f94ec6bedd8674c4426838e6b50417d36b6ab231  # v5.3.1
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install 3.10

    - name: Generate timestamped version
      id: version
      run: |
        TIMESTAMP=$(date -u '+%Y%m%d%H%M%S')
        CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

        # Strip any existing .dev suffix and append new timestamp
        BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/\.dev[0-9]*$//')
        NEW_VERSION="${BASE_VERSION}.dev${TIMESTAMP}"
        echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT

        # Update all version files to keep them in sync
        sed -i "s/^version = .*/version = \"${NEW_VERSION}\"/" pyproject.toml
        sed -i "s/^__version__ = .*/__version__ = \"${NEW_VERSION}\"/" src/plottini/__init__.py
        sed -i -E "s/__version__ == \"[^\"]+\"/__version__ == \"${NEW_VERSION}\"/" tests/test_basic.py
        sed -i -E "s/Plottini version [^ ]+/Plottini version ${NEW_VERSION}/" tests/test_cli.py

        # Verify all replacements succeeded
        grep -q "version = \"${NEW_VERSION}\"" pyproject.toml || { echo "Failed to update pyproject.toml"; exit 1; }
        grep -q "__version__ = \"${NEW_VERSION}\"" src/plottini/__init__.py || { echo "Failed to update __init__.py"; exit 1; }
        grep -q "== \"${NEW_VERSION}\"" tests/test_basic.py || { echo "Failed to update test_basic.py"; exit 1; }
        grep -q "version ${NEW_VERSION}" tests/test_cli.py || { echo "Failed to update test_cli.py"; exit 1; }

        echo "Building version: ${NEW_VERSION}"

    - name: Build package
      run: uv build

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
      with:
        repository-url: https://test.pypi.org/legacy/
